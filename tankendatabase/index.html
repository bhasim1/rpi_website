<!DOCTYPE html>
<html>

<head>
    <title>tanken</title>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="../styles/private.css">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <style>
        * {
            box-sizing: border-box;
        }
        
        h1 button p {
            overflow: hidden;
        }
        
        table {
            margin-left: auto;
            margin-right: auto;
            overflow-y: scroll;
        }
        
        tr {
            width: 90vw;
            max-width: 90vw;
        }
        
        th,
        td {
            width: 30vw;
            max-width: 30vw;
        }
        
        button {
            font-size: 1rem;
            border: 3px solid black;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin: 0.25rem;
        }
        
        #chart {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script defer>
        let nowh = new Date().getHours()
        let nowd = new Date().getDate()
        let nowm = new Date().getMonth()
        let nowy = new Date().getFullYear()
            //table
        let dataarray = []

        $.ajax({
            url: "./prices.json",
            dataType: "json",
            type: "get",
            async: true,
            data: {},
            success: function(data) {
                console.log(data)
                for (let index = 0; index < data.length; index++) {
                    dataarray.push([nowh - index, Math.floor(data[index][0] / 10) / 100,Math.floor(data[index][1] / 10) / 100,Math.floor(data[index][2] / 10) / 100,Math.floor(data[index][3] / 10) / 100, Math.floor(data[index][4] / 10) / 10000])
                    $("#firsttr").after(`<tr class="datanormal"><td class="table-secondary">${formatecripledate(data[index])}</td><td>${Math.floor(data[index][0] / 10)/100}</td><td>${Math.floor(data[index][1] / 10)/100}</td><td>${Math.floor(data[index][2] / 10)/100}</td><td>${Math.floor(data[index][3] / 10)/100}</td><td>${Math.floor(data[index][4] / 10)/10000}</td></tr>`)
                }
            },
            error: function(xhr, exception) {
                var msg = "";
                if (xhr.status === 0) {
                    msg = "Not connect.\n Verify Network." + xhr.responseText;
                } else if (xhr.status == 404) {
                    msg = "Requested page not found. [404]" + xhr.responseText;
                } else if (xhr.status == 500) {
                    msg = "Internal Server Error [500]." + xhr.responseText;
                } else if (exception === "parsererror") {
                    msg = "Requested JSON parse failed.";
                } else if (exception === "timeout") {
                    msg = "Time out error." + xhr.responseText;
                } else if (exception === "abort") {
                    msg = "Ajax request aborted.";
                } else {
                    msg = "Error:" + xhr.status + " " + xhr.responseText;
                }
            }
        });

        function formatecripledate(datetime) {

            var year = datetime[9]
            var month = datetime[8]
            var day = datetime[6]
            var hour = datetime[5]

            return `Y:${year}-M:${month}-D:${day}-H:${hour}`
        };
        //updown btn
        var display = true
        $(document).ready(function() {
            $("#updown").click(function() {
                $("td").toggle(0, function() {
                    if (display === true) {
                        display = false
                        $("#updown").html('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-up" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"/></svg>')
                    } else
                    if (display === false) {
                        display = true
                        $("#updown").html('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 3.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5zM8 6a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 .708-.708L7.5 12.293V6.5A.5.5 0 0 1 8 6z"/></svg>')
                    }
                })
            });
        });
        //chart
        google.charts.load('current', {
            'packages': ['line']
        });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {

            var data = new google.visualization.DataTable();

            data.addColumn('number', 'hours');
            data.addColumn('number', 'diesel');
            data.addColumn('number', 'superE10');
            data.addColumn('number', 'super');
            data.addColumn('number', 'superplus');
            data.addColumn('number', 'heizöl');

            function draw() {
                for (let index = 0; index < dataarray.length - 1; index++) {
                console.log(dataarray[index])
                if (typeof(dataarray[index]) != "undefined") {
                    data.addRows([dataarray[index]])
                }
            }
        }
        google.setOnLoadCallback(draw);


            var chart = new google.charts.Line(document.getElementById('chart'));

            chart.draw(data);
        }

        function search() {
            searchdataarray = []
            removetr()
            let syear = parseInt(document.querySelector("[name=year]").value)
            let smonth = parseInt(document.querySelector("[name=month]").value)
            let sday = parseInt(document.querySelector("[name=day]").value)
            console.log(`./tankenapi.php?year=${syear}&month=${smonth}&day=${sday}`)
            $.ajax({
                url: `./tankenapi.php?year=${syear}&month=${smonth}&day=${sday}`,
                dataType: "json",
                type: "get",
                async: false,
                data: {},
                success: function(data) {

                for (let index = 0; index < data.length; index++) {
                    searchdataarray.push([nowh - index, Math.floor(data[index][0] / 10) / 100,Math.floor(data[index][1] / 10) / 100,Math.floor(data[index][2] / 10) / 100,Math.floor(data[index][3] / 10) / 100, Math.floor(data[index][4] / 10) / 10000])
                    $("#firsttr").after(`<tr class="datanormal"><td class="table-secondary">${formatecripledate(data[index])}</td><td>${Math.floor(data[index][0] / 10)/100}</td<td>${Math.floor(data[index][1] / 10)/100}</td><td>${Math.floor(data[index][2] / 10)/100}</td><td>${Math.floor(data[index][3] / 10)/100}</td>><td>${Math.floor(data[index][4] / 10)/10000}</td></tr>`)
                }
                console.log(data)
                },
                error: function(xhr, exception) {
                    var msg = "";
                    if (xhr.status === 0) {
                        msg = "Not connect.\n Verify Network." + xhr.responseText;
                    } else if (xhr.status == 404) {
                        msg = "Requested page not found. [404]" + xhr.responseText;
                    } else if (xhr.status == 500) {
                        msg = "Internal Server Error [500]." + xhr.responseText;
                    } else if (exception === "parsererror") {
                        msg = "Requested JSON parse failed.";
                    } else if (exception === "timeout") {
                        msg = "Time out error." + xhr.responseText;
                    } else if (exception === "abort") {
                        msg = "Ajax request aborted.";
                    } else {
                        msg = "Error:" + xhr.status + " " + xhr.responseText;
                    }
                }
            });

            /*let trnotfirst = document.querySelectorAll("tr:not(#firsttr)")
                for (let index = 0; index < trnotfirst.length; index++) {
                    let searchelement = trnotfirst[index].innerText.split("")
                    searchelement = searchelement[14] + searchelement[15]
                    if(searchelement === ){
                        trnotfirst[index].style.background = "red"
                    }
                }*/

            var data = new google.visualization.DataTable();

            data.addColumn('number', 'hours');
            data.addColumn('number', 'diesel');
            data.addColumn('number', 'superE10');
            data.addColumn('number', 'super');
            data.addColumn('number', 'superplus');
            data.addColumn('number', 'heizöl');
            console.log(searchdataarray)
        function draw() {
                for (let index = 0; index < dataarray.length - 1; index++) {
                console.log(searchdataarray[index])
                if (typeof(searchdataarray[index]) != "undefined") {
                    data.addRows([searchdataarray[index]])
                }
            }
        }
        google.setOnLoadCallback(draw);
            var chart = new google.charts.Line(document.getElementById('chart'));

            chart.draw(data);


        }

        function removetr() {
            $(".datasearch").remove()
            $(".datanormal").remove()
        }
    </script>
</head>

<body>
    <h1 style="text-align: center; margin: 1rem;">All temps of the last 7 days</h1>
    <div><label for="year">search for year</label><input type="text" name="year"><label for="month">search for month</label><input type="text" name="month"><label for="day">search for day</label><input type="text" name="day"><button onclick="search()">search</button></div>
    <button id="updown">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-bar-up" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 10a.5.5 0 0 0 .5-.5V3.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 3.707V9.5a.5.5 0 0 0 .5.5zm-7 2.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5z"/>
      </svg>
    </button>
    <table class="table">
        <tr id="firsttr">
            <th scope="col" class="table-secondary">datetime</th>
            <th scope="col">diesel</th>
            <th scope="col">superE10</th>
            <th scope="col">super</th>
            <th scope="col">superplus</th>
            <th scope="col">heizöl</th>
        </tr>
    </table>
    <div id="chart" style="width:90vw;  height:80vh;"></div>
</body>

</html>